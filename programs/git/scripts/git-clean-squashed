#!/usr/bin/env bash

# Detect default branch (main or master)
if git show-ref --verify --quiet refs/heads/main; then
  default_branch="main"
elif git show-ref --verify --quiet refs/heads/master; then
  default_branch="master"
else
  echo "Error: Neither 'main' nor 'master' branch exists" >&2
  exit 1
fi

git checkout -q "$default_branch"
git for-each-ref refs/heads/ "--format=%(refname:short)" | while read branch; do
  mergeBase=$(git merge-base "$default_branch" "$branch")
  if [[ $(git cherry "$default_branch" $(git commit-tree $(git rev-parse "$branch"^{tree}) -p "$mergeBase" -m _)) == "-"* ]]; then
    git branch -D "$branch"
  fi
done
